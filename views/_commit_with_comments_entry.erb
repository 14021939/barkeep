<%#
  A single table row for a commit with unresolved comments.
  View arguments:
  - entry: a ReviewListEntry
  - current_user_id: the current user id
  - expand_comments: if true, then mark overflow comments as visible
 %>
<% commit = entry.grit_commit %>
<% comments = entry.comments %>
<% db_commit = MetaRepo.instance.db_commit(commit.repo_name, commit.sha) %>
<tr class="commentEntryRow">
  <td class="tableCellDeleteHidden">
    <a href="#" class="delete">X</a>
  </td>
  <td class="selectArrow <%= "approved east" if db_commit.approved? %>"
      title="Approved" rel="tipsy"></td>
  <td class="avatarCell">
    <div class="avatar">
      <img src="<%= commit.author.gravatar %>"/>
    </div>
  </td>
  <td class="author">
    <a class="south" rel="tipsy" href="mailto:<%= commit.author.email %>" target="_blank"
      title="<%= commit.author.email %>"><%= commit.author.to_s[0..25] %></a>
  </td>
  <td><table class="innerCommitsList innerCommitsWithCommentsList"><tbody>
  <tr class="commitRow">
    <td class="commitId leftBorderCell topBorderCell">
      <a href="<%= commit.link %>" target="_blank" class="commitLink"><%= commit.id_abbrev %></a>
    </td>
    <td class="commitMessage topBorderCell">
      <a href="<%= commit.link %>" target="_blank"><%= CGI::escapeHTML(commit.short_message) %></a>
    </td>
    <td class="commitDate topBorderCell"><%= commit.date.to_pretty %></td>
    <td class="commitRepo topBorderCell"><%= commit.repo_name %></td>
    <td class="commentCount">
      <% comment_count = db_commit.comment_count %>
      <% if comment_count > 0 %>
        <a class="noLink west" rel="tipsy" title="<%= StringHelper.pluralize(comment_count, "comment") %>">
          <span><%= comment_count %></span><img src="<%= asset_url("/assets/images/comment_bubble.png") %>" />
        </a>
      <% end %>
    </td>
  </tr>
  <% overflow_class = expand_comments ? "overflowCommentRow" : "overflowCommentRow commentHidden" %>
  <% comments.each_with_index do |comment, index| %>
  <tr class='commentRow <%= (index >= 2 && comments.length >= 4) ? overflow_class : "" %>'>
    <td colspan="4" class="leftBorderCell <%= (index == comments.length - 1) ? 'bottomBorderCell' : '' %>">
      <span class="<%= (comment.is_resolved && comment.is_by_user(current_user_id)) ? 'tableCellDelete' : 'tableCellDeleteHidden' %>">
        <a href="#" class="deleteCommentRow" data-comment-id="<%= comment.id %>">x</a>
      </span>
      <% label_class, label = TagHelper.get_label_and_class(current_user_id, comment) %>
      <span class="tagLabel <%= label_class %>"><%= label %></span>
      <a href='<%= "#{commit.link}#comment-#{comment.id}" %>' target="_blank"><%= comment.text[0..100] %></a>
    </td>
  </tr>
  <% end %>
  <% if comments.length >= 4 && !expand_comments %>
  <tr class="overflowButtonRow">
    <td colspan="4" class="centerText leftBorderCell bottomBorderCell">
      <a href="#" class="showOverflowComments">Show all <%= comments.length %> comments</a>
    </td>
  </tr>
  <% end %>
  </tbody></table></td>
</tr>
