<div class="file" filename="<%= file[:file_name_before] %>" >
  <div class="filename"> <%= file[:file_name_before] %></div>
  <div class="comments">
  <% line_comments, comment_index = [], 0%>
    <% if commit_file = commit ? commit.commit_files_dataset[:filename => file[:file_name_before]] : nil %>
      <% commit_file.file_comments.each do |comment| %>
        <%= erb :_comment, :locals => {:comment => comment} %>
      <% end %>
      <% line_comments = commit_file.line_comments %>
    <% end %>
  </div>
  <table class="data">
    <% if file[:binary] %>
      <tr>
        <td class="fileBinary">binary file</td>
      </tr>
    <% else %>
      <% file[:lines].each_with_index do |line, index| %>
        <tr class="diffLine <%= line.tag == :same ? "same" : "diff" %>" diff-line-number="<%= index + 1 %>">
          <td class="lineNumber"><%= line.line_num_before || "&nbsp;" %></td>
          <td class="lineNumber"><%= line.line_num_after || "&nbsp;" %></td>
          <td class="code">
            <%= line.formatted %>
            <% # add line comments
               while comment_index < line_comments.length &&
                line_comments[comment_index].line_number == index + 1 %>
                  <%= erb :_comment, :locals => {:comment => line_comments[comment_index]} %>
                <% comment_index += 1 %>
            <% end %>
          </td>
        </tr>
      <% end %>
    <% end %>
  </table>
</div>
